<!DOCTYPE html>
<html>
<head>
  <title>JGM Christmas Carols</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    /* --- CHURCH THEME CSS --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 15px; margin: 0; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    h2 { text-align: center; color: #2c3e50; margin-top: 0; margin-bottom: 5px; }
    p.subtitle { text-align: center; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 25px; }
    
    label { font-weight: 600; display: block; margin-top: 15px; margin-bottom: 5px; color: #34495e; font-size: 0.9rem; }
    
    input, select, button, textarea { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 16px; background: #fff; }
    textarea { min-height: 80px; resize: vertical; font-family: inherit; }
    
    /* Grid for DOB and Age */
    .row-grid { display: flex; gap: 10px; }
    .row-grid > div { flex: 1; }
    
    /* Readonly Age Field (Grayed out) */
    .age-box { background-color: #e9ecef; color: #555; font-weight: bold; cursor: not-allowed; }

    .section-title { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; font-size: 1.1rem; color: #c0392b; font-weight: bold; }

    /* Family Cards */
    .family-card { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; }
    .delete-btn { position: absolute; top: -10px; right: -5px; background: #e74c3c; color: white; width: 28px; height: 28px; border-radius: 50%; padding: 0; font-size: 14px; line-height: 28px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;}
    
    
    .add-btn { background-color: #3498db; color: white; border: none; margin-bottom: 20px; }
    .loc-btn { background-color: #27ae60; color: white; font-weight: bold; margin-bottom: 5px; border: 2px solid #27ae60; }
    .loc-error { border-color: red !important; background-color: #ffe6e6 !important; color: #c0392b !important; }
    .loc-failed { background-color: #e67e22 !important; border-color: #e67e22 !important; color: white !important; } 

    .submit-btn { background-color: #d35400; color: white; font-size: 18px; font-weight: bold; margin-top: 15px; height: 50px; }
    #map { height: 200px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc; display:none; }
    .map-visible { display: block !important; }
    #status { text-align: center; margin-top: 15px; font-weight: bold; }
    #loc-msg { font-size: 0.85rem; color: #666; margin-bottom: 10px; text-align: center; }
  </style>
</head>
<body>

<div class="container">
  <h2>üéÑ JGM Christmas Carols</h2>
  <p class="subtitle">Please fill details for house visit</p>

  <form id="myForm">
    
    <div class="section-title">üë§ Your Details (Primary Contact)</div>
    
    <label>Full Name</label>
    <input name="PrimaryName" type="text" placeholder="Enter Name" required>

    <label>Mobile Number</label>
    <input name="Mobile" type="tel" placeholder="10-digit Number" required>

    <div class="row-grid">
        <div style="flex: 2;"> <label>Date of Birth</label>
            <input name="PrimaryDOB" type="date" id="mainDob" onchange="calcAge(this, 'mainAge')" required>
        </div>
        <div style="flex: 1;"> <label>Age</label>
            <input type="text" id="mainAge" class="age-box" placeholder="0" readonly>
        </div>
    </div>
    
    <label>Gender</label>
    <select name="PrimaryGender" required>
        <option value="">Select</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
    </select>

    <div class="section-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Other Family Members</div>
    <p style="font-size: 0.8rem; color: #666; margin-top:-10px; margin-bottom: 15px;">Add everyone else living in the house.</p>
    
    <div id="family-container"></div>

    <button type="button" class="add-btn" onclick="addMember()">+ Add Family Member</button>

    <input type="hidden" name="FamilyDetails" id="finalFamilyData">

    <div class="section-title">üôè Prayer Request</div>
    <textarea name="PrayerRequest" placeholder="Enter your prayer request (optional)" rows="4"></textarea>

    <div class="section-title">üí∞ Offering</div>
    <input name="Offering" type="number" placeholder="Enter amount (optional)" min="0" step="0.01">

    <div class="section-title">üë®‚Äçüíº Pastor Who Visited</div>
    <select name="PastorVisited" required>
        <option value="">Select Pastor</option>
        <option value="Ps. Joshua Gummala">Ps. Joshua Gummala</option>
        <option value="Ps. Roja Gummala">Ps. Roja Gummala</option>
        <option value="Ps. Param Jyothi">Ps. Param Jyothi</option>
        <option value="Ps. Joshua Deeven">Ps. Joshua Deeven</option>
        <option value="Ps. Paul Prashanth">Ps. Paul Prashanth</option>
    </select>

    <div class="section-title">üìç House Location <span style="color:red">*</span></div>
    
    <input name="Latitude" type="hidden" id="lat">
    <input name="Longitude" type="hidden" id="lng">
    <input type="hidden" id="locationAttempted" value="false">

    <p id="loc-msg">You <b>must</b> click the button below to share location.</p>

    <button type="button" class="loc-btn" id="locBtn" onclick="getLocation()">üìç Click to Share Location</button>
    
    <div id="map"></div>

    <button type="submit" id="submitBtn" class="submit-btn">Submit Information</button>

  </form>
  <p id="status"></p>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- 1. AGE CALCULATOR LOGIC ---
    function calcAge(dateInput, ageOutputId) {
        const dobValue = dateInput.value;
        if (!dobValue) return;

        const dob = new Date(dobValue);
        const today = new Date();
        
        let age = today.getFullYear() - dob.getFullYear();
        const monthDiff = today.getMonth() - dob.getMonth();
        
        // Adjust if birthday hasn't happened yet this year
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
            age--;
        }
        
        // Prevent negative age
        if (age < 0) age = 0;

        // Update the Age box
        if (ageOutputId) {
            document.getElementById(ageOutputId).value = age;
        } else {
            // If no ID provided (for dynamic rows), find the sibling input
            // This logic is handled inside the onchange of the dynamic row
            return age;
        }
    }

    // --- 2. FAMILY LOGIC ---
    function addMember() {
        const container = document.getElementById('family-container');
        const card = document.createElement('div');
        card.className = 'family-card';
        // Note the onchange event on the date input below
        card.innerHTML = `
            <button type="button" class="delete-btn" onclick="this.parentElement.remove()">‚úï</button>
            <label style="margin-top:0">Name</label>
            <input type="text" class="mem-name" placeholder="Name" style="margin-bottom:10px">
            <label>Relation</label>
            <select class="mem-relation" style="margin-bottom:10px">
                <option value="">Select Relation</option>
                <option value="Wife">Wife</option>
                <option value="Husband">Husband</option>
                <option value="Son">Son</option>
                <option value="Daughter">Daughter</option>
                <option value="Father">Father</option>
                <option value="Mother">Mother</option>
                <option value="Brother">Brother</option>
                <option value="Sister">Sister</option>
                <option value="Grandparent">Grandparent</option>
                <option value="Friend">Friend</option>
                <option value="Relative">Relative</option>
                <option value="Other">Other</option>
            </select>
            
            <div class="row-grid">
                <div style="flex:2">
                    <label>Date of Birth</label>
                    <input type="date" class="mem-dob" onchange="updateDynamicAge(this)">
                </div>
                <div style="flex:1">
                    <label>Age</label>
                    <input type="text" class="mem-age age-box" placeholder="0" readonly>
                </div>
            </div>

            <label>Gender</label>
            <select class="mem-gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
        `;
        container.appendChild(card);
    }


    // Helper for dynamic rows
    function updateDynamicAge(input) {
        const age = calcAge(input); // Calculate age
        // Find the age input in the same row-grid
        const ageBox = input.parentElement.parentElement.querySelector('.mem-age');
        ageBox.value = age;
    }

    // --- 3. LOCATION LOGIC ---
    var map, marker;
    function getLocation() {
        const status = document.getElementById('status');
        const locBtn = document.getElementById('locBtn');
        const locMsg = document.getElementById('loc-msg');
        const attemptTracker = document.getElementById('locationAttempted');
        
        attemptTracker.value = "true";

        if (!navigator.geolocation) { handleLocFailure("GPS Not Supported"); return; }
        
        locBtn.innerHTML = "‚è≥ Finding Location...";
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById('lat').value = lat;
                document.getElementById('lng').value = lng;
                
                locBtn.innerHTML = "‚úÖ Location Found!";
                locBtn.style.backgroundColor = "#27ae60"; 
                locBtn.classList.remove('loc-error', 'loc-failed'); 
                locMsg.innerHTML = "Location saved. You can submit now.";
                locMsg.style.color = "green";
                
                document.getElementById('map').classList.add('map-visible');
                if (!map) {
                    map = L.map('map').setView([lat, lng], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
                } else {
                    map.setView([lat, lng], 16);
                    map.invalidateSize();
                }
                if (marker) marker.setLatLng([lat, lng]);
                else marker = L.marker([lat, lng]).addTo(map);
            },
            (error) => { handleLocFailure("GPS Failed"); },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    }

    function handleLocFailure(reason) {
        const locBtn = document.getElementById('locBtn');
        const locMsg = document.getElementById('loc-msg');
        locBtn.innerHTML = "‚ö†Ô∏è Location Failed (Tap to Retry)";
        locBtn.classList.add('loc-failed');
        locBtn.classList.remove('loc-error');
        locMsg.innerHTML = "Could not find map location, but <b>you can Submit now.</b>";
        locMsg.style.color = "#e67e22"; 
    }

    // --- 4. SUBMIT LOGIC ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzfduoOesMHqOd2FFTTILI196f_6b1I1PldYoWVWB5gI7TglphdPPlY8Qs_zqWa1GvD2g/exec'; // <--- PASTE SCRIPT URL HERE
    const form = document.getElementById('myForm');
    
    form.addEventListener('submit', e => {
        e.preventDefault();
        
        const lat = document.getElementById('lat').value;
        const attempted = document.getElementById('locationAttempted').value;
        const locBtn = document.getElementById('locBtn');
        
        if(!lat && attempted === "false") {
            locBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            locBtn.classList.add('loc-error');
            locBtn.innerHTML = "‚ö†Ô∏è REQUIRED: Click to Share Location";
            alert("Please CLICK the Location button first.");
            return; 
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = "Submitting...";

        // GATHER FAMILY DATA
        let familyData = [];
        document.querySelectorAll('.family-card').forEach(card => {
            const name = card.querySelector('.mem-name').value;
            const relation = card.querySelector('.mem-relation').value;
            const age = card.querySelector('.mem-age').value; // We send AGE now, not DOB
            const gender = card.querySelector('.mem-gender').value;
            
            // Format: "Name (Relation, 5 yrs, Male)"
            if(name) familyData.push(`${name} (${relation}, ${age} yrs, ${gender})`);
        });
        document.getElementById('finalFamilyData').value = familyData.join(" | ");

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
        .then(response => {
            document.getElementById('status').innerHTML = "‚úÖ Details Submitted! God Bless.";
            form.reset();
            document.getElementById('family-container').innerHTML = ""; 
            document.getElementById('map').classList.remove('map-visible');
            document.getElementById('locationAttempted').value = "false";
            locBtn.innerHTML = "üìç Click to Share Location"; 
            locBtn.classList.remove('loc-failed', 'loc-error');
            locBtn.style.backgroundColor = ""; 
            btn.disabled = false;
            btn.innerHTML = "Submit Information";
        })
        .catch(error => {
            document.getElementById('status').innerHTML = "‚ùå Error! " + error.message;
            btn.disabled = false;
        });
    });
</script>

</body>
</html>
